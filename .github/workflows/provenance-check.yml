name: Provenance Engine Confirm # Or "Provenance Check"
permissions:
  contents: read
on:
  pull_request:
    types: [opened, synchronize, reopened] # Or just [pull_request]

jobs:
  provenance_check: # Or "check"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect diff
        id: diff
        run: |
          echo "DIFF<<EOF" >> $GITHUB_ENV
          git diff HEAD~1 HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Provenance Engine
        id: check
        run: |
          BODY=$(jq -n \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg branch "${GITHUB_HEAD_REF}" \
            --arg commit "${GITHUB_SHA}" \
            --arg author "${GITHUB_ACTOR}" \
            --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --arg pr "${{ github.event.pull_request.number }}" \
            --arg diff "${DIFF}" \
            --argjson files "[] | . += [$(
                git diff --name-only HEAD~1 HEAD | jq -R . | jq -s .
              )]" \
            '{repo: $repo, branch: $branch, commit: $commit, author: $author, timestamp: $timestamp, pr_number: ($pr|tonumber), diff: $diff, files_changed: $files}'
          )

          RESPONSE=$(curl -s -X POST "https://fly.io/apps/the-provenance-engine/deployments/538318" \
            -H "Authorization: Bearer ${{ secrets.PROVENANCE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "$RESPONSE" > response.json

          STATUS=$(jq -r '.status' response.json)

          if [ "$STATUS" != "pass" ]; then
            echo "❌ Provenance validation failed."
            cat response.json
            exit 1
          fi

          echo "✅ Provenance validation passed."


    name: Provenance Check
    permissions:
  contents: read

  on: [pull_request]
  runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'
          
      - name: Verify provenance
        run: |
          # Download provenance record from base branch
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o base_provenance.json \
            "${{ github.api_url }}/repos/${{ github.repository }}/contents/.provenance/PROVENANCE.signed.json?ref=${{ github.base_ref }}"
            
          # Verify signature and record integrity
          python -c '
          import json
          import hashlib
          from pathlib import Path
          
          def verify_provenance(signed_json):
              with open(signed_json) as f:
                  data = json.load(f)
                  
              # Verify all referenced artifacts exist and match hashes
              for artifact in data["artifacts"]:
                  path = artifact["path"]
                  expected_hash = artifact["hash"]
                  if not Path(path).exists():
                      return False, f"Missing artifact: {path}"
                  
                  actual_hash = hashlib.sha256(Path(path).read_bytes()).hexdigest()
                  if actual_hash != expected_hash:
                      return False, f"Hash mismatch for {path}"
                      
              # Verify signature (would call external service)
              return True, "Provenance verified"
              
          ok, msg = verify_provenance("base_provenance.json")
          if not ok:
              print(f"Provenance check failed: {msg}")
              exit(1)
          print("Provenance check passed")'
