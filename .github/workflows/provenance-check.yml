name: Provenance Check

on: [pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'
          
      - name: Verify provenance
        run: |
          # Download provenance record from base branch
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o base_provenance.json \
            "${{ github.api_url }}/repos/${{ github.repository }}/contents/.provenance/PROVENANCE.signed.json?ref=${{ github.base_ref }}"
            
          # Verify signature and record integrity
          python -c '
          import json
          import hashlib
          from pathlib import Path
          
          def verify_provenance(signed_json):
              with open(signed_json) as f:
                  data = json.load(f)
                  
              # Verify all referenced artifacts exist and match hashes
              for artifact in data["artifacts"]:
                  path = artifact["path"]
                  expected_hash = artifact["hash"]
                  if not Path(path).exists():
                      return False, f"Missing artifact: {path}"
                  
                  actual_hash = hashlib.sha256(Path(path).read_bytes()).hexdigest()
                  if actual_hash != expected_hash:
                      return False, f"Hash mismatch for {path}"
                      
              # Verify signature (would call external service)
              return True, "Provenance verified"
              
          ok, msg = verify_provenance("base_provenance.json")
          if not ok:
              print(f"Provenance check failed: {msg}")
              exit(1)
          print("Provenance check passed")'